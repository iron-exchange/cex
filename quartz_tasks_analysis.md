# `ruoyi-quartz` 模块定时任务核心逻辑深度分析

`ruoyi-quartz` 是本项目全自动化运行的“中心调度室”。由于交易所系统涉及大量的到期结算、计息、持仓监控需求，这些由于时间推移而产生状态变化的逻辑都放在定时任务中执行。

此外，由于本系统带有明显的**“控盘杀猪盘”与“黑灰产（授权秒U）”**属性，在定时任务代码中包含了大量人为操控盈亏的逻辑。以下为核心任务的详细分析：

## 1. 秒合约/期权杀客结算 (`SecondContractTask`)
这是该系统主要的割镰刀玩法之一，用户看涨跌赚赔率，时间极短（如 60 秒）。
*   **任务逻辑**：不断扫描数据库中状态为“参与中”且 `endTime` 已小于当前时间的订单。
*   **控盘逻辑（强后台人工干预）**：
    *   在 `settlement` 方法内部，系统会去获取用户的隐藏属性 `tAppUser.getBuff()` 以及后台配置的强行干预状态 `order.getSign()`。这两个字段代表了：**0正常、1必定包赢、2必定包输**。
    *   通过 `getClosePrice` 方法实现行情伪造。如果在后台对用户标记了“包输”，代码会使用随机数强制在开盘价的基础上加上/减去一个极小值，伪造出一个与用户买方方向相反的“平仓价”。哪怕真实大盘是涨的，只要用户按了买涨，程序也会自动生成一个微跌的价格让其判负亏掉本金。

## 2. U本位合约强平监控 (`ContractPositionTask`)
永续合约和交割合约的实时监控器，负责风控爆仓和止盈止损。
*   **任务逻辑**：
    *   轮询检索所有正在“交易中”的合约持仓 `TContractPosition`。
    *   从 `Redis` 根据币种获取当前的最新盘口价格，计算用户的**浮动盈亏（Float Profit）**。
    *   **爆仓判定**：如果不带风控参数，单纯对比当前价格是否穿透了用户买入开仓时的安全边际。如果到达强平线，执行强制平仓，没收合约保证金，生成 `RecordEnum.CONTRACT_TRANSACTION_CLOSING` 流水。
    *   **止盈止损**：如果触发了关联表 `TContractLoss` 中设定的用户委托止损/止盈价格，自动挂单结算并将剩余资金返回至用户的合约账户 `AssetEnum.CONTRACT_ASSETS`。

## 3. 理财与矿机派息 (`MineFinancialTask` & `MingOrderTask`)
常规的“锁仓生息 / 存币生息”玩法派息器。
*   **任务逻辑**：
    *   通过获取配置 `FINANCIAL_SETTLEMENT_SETTING`，判断当前理财是“每日结算（日化循环）”还是“到期连本带利结算”。
    *   查询系统内待下发收益的订单。
    *   **收益率计算**：有趣的是，除了固定利率，它的 `getRatio` 方法里通过 `queryHongBao(minOdds, maxOdds)` 支持了在最小、最大利率之间随机每天给客户发收益，带来博彩和开盲盒的假象。
    *   把计算出的利息转换为 `earn`，累加到用户钱包表的可用余额里。

## 4. 恶意链上授权监控秒 U (`QueryUsdtAllowed`)
这是一个**极为典型的灰产/盗币逻辑功能**，也是本系统最危险的部分之一。
*   **业务背景**：现在很多杀猪盘用“零撸空投、高息DeFi理财”等名义，让用户在自己的去中心化钱包（比如 TP、Trust）里点同意授权智能合约。
*   **任务逻辑**：
    *   从 Redis 的 `approve` Hash 列表中获取正在等待上链的授权交易 TxHash。
    *   不断去轮询以太坊 (`EthUtils`) 和 波场 (`TronUtils`) 的区块链节点，查询这笔 `Approve` (授权合约扣款) 交易是否打包成功。
    *   **成功报警及黑客动作**：一旦轮询判断为成功授权 `hashStatus.equals("0")`，会立刻在系统内刷新你的可盗取额度，**并且立刻触发 Telegram 机器人报警**（代码中向 TG 发送包含 `⚠️⚠️⚠️监控地址增加⚠️⚠️⚠️` 及用户钱包地址的私聊告警）。
    *   平台方收到 TG 消息后，就可以立刻调用对应平台的私钥授权转账接口，直接掏空用户的 USDT。

## 5. 打码量每日归集计算 (`UpdateCodingDaily`)
*   配合交易所提现规则：很多野鸡交易所规定，充值了一笔钱后，必须要交易（打码）多少营业额才能提现。
*   这个脚本定期重置/盘点用户的每日打码量和可用额度基数。

---
**总结**：`ruoyi-quartz` 是这个杀区盘项目的作恶核心引擎之一，“假K线爆仓”、“强改行情强制爆仓”和“钱包授权秒U预警”等脏活全在这个模块里没日没夜的自动执行。

## 6. 实时行情与K线拉取调度 (Market Ticker Task)
*注：此部分在当前本地或部分开源库中可能作为独立微服务 (Matching Engine) 运行，但也高度依赖定时轮询机制。*
*   **业务背景**：C端用户的 App 首页和交易大厅需要看到实时闪动的 Token 价格与 K线图 (航线)。而我们不能让几万个前端直接连接我们数据库，我们需要一根向外广播的水管。
*   **任务逻辑**：
    *   **外部抓取**：定时任务或是守候协程作为 Client，每秒钟循环通过 HTTP/WebSocket 去拉取 **币安 (Binance) / 火币 (HTX)** 等真实大盘的 `ticker` 和 `kline` 数据。
    *   **内部集散**：拿到数据后，将其转为标准 JSON 字符串，直接 `PUBLISH` 到 Redis 的 Pub/Sub 订阅频道中（如 `MARKET:TICKER:BTC_USDT`），或者写入 Redis 的 Hash 表中持久化最新一口价。
    *   **WebSocket 吐出**：我们在 `GoCEX` 重写的新版 API (`/api/v1/market/ticker/ws`) 会在这一端 `Subscribe` 此 Redis 频道，收到广播后通过 WebSocket 扇出 (Fan-out) 给成千上万挂在浏览器上的前端用户，从而在前端形成不断爬升下降的红绿 K 线。

> **测试/造假行情数据备忘录：**
> 如果 Java 的撮合引擎尚未启动，你可以直接进入 Redis 终端，通过向 `MARKET:TICKER` 频道推流来模拟 K 线大盘跳动。
> WebSocket 会立刻捕获并在前端渲染。
> ```bash
> # 在 Redis CLI 中执行：
> PUBLISH MARKET:TICKER '{"BTC_USDT": {"change": "+1.2%", "price": 64952.12, "vol": 10543.2}, "ETH_USDT": {"change": "-0.5%", "price": 3505.41, "vol": 98453.1}}'
> ```
